# Daemonset

- 데몬셋은 클러스터에 노드 단위로 파드를 실행하기 위해 제공되는 추상 객체입니다. (라벨을 지정해주지 않는다면 클러스터의 모든 `node`에 각각 하나의 Pod 배포)

> 노드?
>> 쿠버네티스는 컨테이너를 파드내에 배치하고 노드 에서 실행함으로 워크로드를 구동한다. 노드는 클러스터에 따라 가상 또는 물리적 머신일 수 있다. 각 노드에는 컨트롤 플레인이라는 파드를 실행하는데 필요한 서비스가 포함되어 있다. ([kubernetes.io](https://kubernetes.io/ko/docs/concepts/architecture/nodes/))

- 데몬셋은 특히 모니터링, 로깅 에이전트와 같은 핵심 서비스가 항상 클러스터의 올바른 노드에서 실행되고 관리되도록 컨트롤러 및 스케줄러를 제공합니다.

> *일부 애플리케이션은 안정적인 운영에 필요한 충분한 리소스와 이에 대한 분배가 있는 경우 실제로 실행되는 곳은 중요하지 않기 때문에 특정 수의 복제본을 스케줄링하기만 하면 되지만, **에이전트 및 모니터링 애플리케이션 등이 제대로 동작하려면 클러스터 내 모든 머신에 위치해야 합니다.** 이러한 데몬셋은 기존 애플리케이션과 같이 서비스를 담당하기보단 클러스터에 추가적인 기능을 제공합니다. 데몬셋은 명시적으로 배치하지 않아도 모든 머신에 에이전트가 실행되도록 선언할 수 있습니다. 이는 사용자 개입없이 노드가 추가되고 제거되는 환경(k8s의 auto-scale 환경)에서 유용합니다. 자동 확장기에 의해 클러스터에 노드가 추가될 때 데몬셋은 각 노드에 적절한 에이전트를 자동으로 추가합니다.* (p.213 쿠버네티스 시작하기 2/e)

- 레플리카셋은 특별한 고려사항 없이 주어진 노드에 여러 개의 복사본을 실행할 수 있지만, 데몬셋은 애플리케이션의 **단일 복사본**이 클러스터의 모든 노드 또는 특정 노드 집합에서 실행되야 할 때 사용합니다.

## 예시
> 워커 노드가 3개 구성에서, fluentd를 데몬셋으로 띄웠을 경우

만약 노드당 하나의 파드를 실행하기를 원한다면 k8s 리소스 중 `daemonset`을 사용해야합니다.

만약 워커 노드를 4개로 늘려주게 되면, fluentd 파드가 4개 동작하게 됩니다.

```bash
$ kubectl get all -A

# 데몬셋
kube-system     daemonset.apps/fluentd                                           3         3         3       3            3           <none>                                     6d

# 실제 pod
kube-system     pod/fluentd-d92w2                                               1/1     Running     0          6d
kube-system     pod/fluentd-f77tt                                               1/1     Running     0          6d
kube-system     pod/fluentd-lzgl7                                               1/1     Running     0          6d
```

## 데몬셋 스케줄러

- 기본적으로 데몬셋은 `node selector` 설정이 없다면 모든 워커 노드 당 하나의 파드 복제본을 생성합니다.
- 레플리카셋과 마찬가지로 데몬셋은 조정 루프(reconciliation loop)를 통해 관리됩니다.

 ## 명령어

```bash
kubectl apply -f <데몬셋 파일> # 생성
kubectl describe daemonset fluentd # fluentd 데몬셋 상태 확인
```

## 데몬 셋을 특정 노드로 제한

특별하게 취급되야하는 노드가 존재할 경우, **`node label`을 사용해 일부 노드에만 파드를 배포하는 데몬셋 설정 또한 가능합니다.** 

```bash
k get nodes # 노드 이름 확인

k label nodes <노드 이름> <라벨key=라벨val>

k get nodes -l <라벨key=라벨val>
```

- cli 명령어 대신 yaml로 선언형으로 관리 또한 가능합니다. 